name: Review Quarantine PR

on:
  # PRs from forks must use pull_request_target to allow commenting
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  issues: write        # create/update PR (issue) comments
  pull-requests: read  # read PR metadata

jobs:
  quarantine-notify:
    name: Notify maintainers for quarantine changes
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      issues: write
      pull-requests: write
    env:
      # Static file allowlist
      QUARANTINE_FILES: |
        scripts/quarantine.yaml
        scripts/quarantine_integration.yaml
        scripts/quarantine_no_optimization.yaml
        scripts/quarantine_windows_mac.yaml
        scripts/quarantine_llvm.yaml

      # Pass PR metadata via env and use native $VAR in scripts (avoids injection).
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
      HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      FORK_FULL: ${{ github.event.pull_request.head.repo.full_name }}
      REPO: ${{ github.repository }}
      PR_NUMBER: ${{ github.event.pull_request.number }}

    steps:
      # Checkout the trusted base repo; do NOT checkout untrusted PR head.
      - name: Checkout base repository (safe)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          fetch-depth: 0
          persist-credentials: false

      # Fetch the PR by immutable SHA from the fork via public HTTPS, without a token.
      # Also validate inputs before use.
      - name: Fetch PR HEAD safely (no checkout, no token)
        shell: bash
        run: |
          set -euo pipefail
          export GIT_TERMINAL_PROMPT=0

          # Ensure no auth header leaks to the public fork.
          git config --local --unset-all http.https://github.com/.extraheader || true

          # Basic input validation
          if ! [[ "$HEAD_SHA" =~ ^[0-9a-fA-F]{40}$ ]]; then
            echo "Invalid HEAD_SHA: $HEAD_SHA"
            exit 1
          fi
          if ! [[ "$FORK_FULL" =~ ^[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+$ ]]; then
            echo "Invalid FORK_FULL: $FORK_FULL"
            exit 1
          fi

          # Fetch by SHA into a local ref without adding a persistent remote.
          git -c http.https://github.com/.extraheader= \
              fetch --no-tags --depth=1 "https://github.com/$FORK_FULL.git" \
              "$HEAD_SHA:refs/remotes/pr_head"

      - name: Detect changes in quarantine files
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          # Build an array of allowlisted files (skip blank lines)
          mapfile -t QFILES < <(printf '%s\n' "$QUARANTINE_FILES" | sed '/^\s*$/d')
          if [[ ${#QFILES[@]} -eq 0 ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git diff --name-only "$BASE_SHA" pr_head -- "${QFILES[@]}" | grep -q .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop early if not changed
        if: steps.changed.outputs.changed != 'true'
        run: echo "Quarantine files not changed; skipping."

      - name: Generate diff of quarantine files only (U100 context)
        if: steps.changed.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t QFILES < <(printf '%s\n' "$QUARANTINE_FILES" | sed '/^\s*$/d')
          git diff -U100 "$BASE_SHA" pr_head -- "${QFILES[@]}" > diff_quarantine.txt
          head -n 100 diff_quarantine.txt || true

      - name: Install Python deps
        if: steps.changed.outputs.changed == 'true'
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyyaml

      - name: Prepare comment body (token-free Python)
        if: steps.changed.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/ci/quarantine_notifier.py \
            --repo-root . \
            --diff-file diff_quarantine.txt \
            --output quarantine_comment.md \
            --audit-json quarantine_audit.json \
            --inventory-json scenario_inventory.json \
            --ref "$HEAD_SHA" \
            --strict-missing-codeowners \
            --strict-flag-file strict_missing_codeowners.flag

      - name: Post or update PR comment (base context)
        if: steps.changed.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          [[ -s quarantine_comment.md ]] || { echo "No maintainer notifications to post."; exit 0; }

          BODY="$(cat quarantine_comment.md)"
          existing_id="$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.body | contains("Quarantine update â€“ notifying maintainers")) | .id' || echo "")"

          if [[ -n "$existing_id" ]]; then
            echo "Updating existing quarantine notification comment (id=$existing_id)."
            gh api -X PATCH "repos/$REPO/issues/comments/$existing_id" -f body="$BODY" > /dev/null
          else
            echo "Creating quarantine notification comment."
            gh pr comment "$PR_NUMBER" --body "$BODY" > /dev/null
          fi

      - name: Upload audit artifacts
        if: steps.changed.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: quarantine-audit-pr${{ github.event.pull_request.number }}-run${{ github.run_id }}
          path: |
            diff_quarantine.txt
            quarantine_comment.md
            quarantine_audit.json
            scenario_inventory.json
            strict_missing_codeowners.flag
          if-no-files-found: ignore
          retention-days: 30

      - name: Fail if strict violation (missing CODEOWNERS)
        if: steps.changed.outputs.changed == 'true'
        shell: bash
        run: |
          if [[ -f strict_missing_codeowners.flag ]]; then
            echo "Strict mode: Missing CODEOWNERS detected. Failing the job."
            cat strict_missing_codeowners.flag
            exit 1
          else
            echo "Strict mode: no violations."
          fi
